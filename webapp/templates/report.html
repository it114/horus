{% extends 'base.html' %}

{% block body %}
    <h3 id="report_head"></h3>
    <div class="row-fluid" style="text-align: center;">
        <button class="btn btn-info">Static Analysis</button>
        <button class="btn btn-success">Dynamic Analysis</button>
    </div>
    <hr/>

    <div class="panel-group" id="report-body">
        <div class="panel panel-default" id="basic">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#basicinfo" class="collapsed">
                <h4 style="padding: 15px">Basic APP and File info<small> APK info</small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="basicinfo" class="panel-collapse collapse" style="height: 0px; padding-top: 20px; padding-bottom: 20px;">
            <div class="panel-body">
                <div class="row-fluid">
                    <div class="col col-lg-6">
                        <div class="list-group">
                        <p id="name"><span class="label label-primary">Name</span> </p>
                        <p id="size"><span class="label label-primary">Size</span> </p>
                        <p id="md5"><span class="label label-primary">MD5</span> </p>
                        <p id="sha1"><span class="label label-primary">SHA1</span> </p>
                        <p id="sha256"><span class="label label-primary">SHA256</span> </p>
                        </div>
                    </div>
                    <div class="col col-lg-6">
                        <div class="list-group">
                            <p id="package_name"><span class="label label-primary">Package Name</span> </p>
                            <p id="main_activity"><span class="label label-primary">Main Activity</span> </p>
                            <p id="target_sdk_version"><span class="label label-primary">Target SDK</span> </p>
                            <p id="min_sdk_version"><span class="label label-primary">Min SDK</span> </p>
                            <p id="max_sdk_version"><span class="label label-primary">Max SDK</span> </p>
                            <p id="version_name"><span class="label label-primary">Version Name</span> </p>
                            <p id="version_code"><span class="label label-primary">Version Code</span> </p>
                        </div>
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="list-group">
                        <p id="native"><span class="label label-primary">Native</span> </p>
                        <p id="dynamic"><span class="label label-primary">Dynamic</span> </p>
                        <p id="reflection"><span class="label label-primary">Reflection</span> </p>
                        <p id="obfuscation"><span class="label label-primary">Obfuscation</span> </p>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <div class="panel panel-default" id="files">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#filelist" class="collapsed">
                <h4 style="padding: 15px">Filelist <small>Files in the APK</small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="filelist" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body"><pre id="filelist-body"></pre></div>
        </div>
        </div>
        <div class="panel panel-default" id="perm">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#permissions" class="collapsed">
                <h4 style="padding: 15px">Permissions <small>List of permissions in the apk</small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="permissions" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <th>PERMISSION</th>
                                <th>STATUS</th>
                                <th>INFO </th>
                                <th>DESCRIPTION</th>
                            </tr>
                        </thead>
                        <tbody id="permissions-body"> 
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#aprsl" class="collapsed">
                <h4 style="padding: 15px">Activities, Providers, Receivers, Services and Libraries<small></small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="aprsl" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body">
                <ul class="nav nav-tabs">
                    <li><a href="#activities" data-toggle="tab">Activities</a></li>
                    <li><a href="#providers" data-toggle="tab">Providers</a></li>
                    <li><a href="#receivers" data-toggle="tab">Receivers</a></li>
                    <li><a href="#services" data-toggle="tab">Services</a></li>
                    <li><a href="#libraries" data-toggle="tab">Libraries</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane" id="activities"><pre></pre></div>
                    <div class="tab-pane" id="providers"><pre></pre></div>
                    <div class="tab-pane" id="receivers"><pre></pre></div>
                    <div class="tab-pane" id="services"><pre></pre></div>
                    <div class="tab-pane" id="libraries"><pre></pre></div>
                </div>
            </div>
        </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#cert" class="collapsed">
                <h4 style="padding: 15px">Certificate <small>APK Signing cert</small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="cert" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body"><pre id="cert-body"></pre></div>
        </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#manifest-analysis" class="collapsed">
                <h4 style="padding: 15px">Manifest Analysis <small>Static analysis of the Manifest.xml file</small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="manifest-analysis" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <th>ISSUE</th>
                                <th>SEVERITY</th>
                                <th>DESCRIPTION</th>
                            </tr>
                        </thead>
                        <tbody id="manifest-anal-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#seu" class="collapsed">
                <h4 style="padding: 15px">Strings, Email, URLs<small></small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="seu" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body">
                <ul class="nav nav-tabs">
                    <li><a href="#strings" data-toggle="tab">Strings</a></li>
                    <li><a href="#email" data-toggle="tab">Email</a></li>
                    <li><a href="#urls" data-toggle="tab">URLs</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane" id="strings"><pre></pre></div>
                    <div class="tab-pane" id="email"><pre></pre></div>
                    <div class="tab-pane" id="urls"><pre></pre></div>
                </div>
            </div>
        </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" style="padding: 0 15px">
            <div class="row">
                <div class="col-md-10" style="padding-left: 15px">
                <h4 class="panel-title">
                <a data-toggle="collapse" href="#cfg" class="collapsed">
                <h4 style="padding: 15px">Control Flow Graph <small>CFG graph APK</small></h4>
                </a>
                </h4>
            </div>
            </div>
            </div>
            <div id="cfg" class="panel-collapse collapse" style="height: 0px;">
            <div class="panel-body" id="cfg-body">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
var list = document.URL.split("/");
var app = list[list.length-2];
var status = list[list.length-1].indexOf("Done" || "Running");

function changeStatus(status) {
    $.post("/api"+app+"/"+status, function(data) {
        if (data) {
            console.log("Changed!");
        }
    });
}

function populate(d) {
    console.log(d);
    $('.overlay').remove();
    changeStatus("Done");
    $('#report_head').html('<b><u>Target APK</u></b>: '+d.name);
    for (var file in d.file_types) {
        $('#filelist-body').append(String(file)+' - '+d.file_types[file]+'\n');
    }
    $('#name').append(d.name);
    $('#size').append(d.size+" MB");
    $('#md5').append(d.hashes["md5"]);
    $('#sha1').append(d.hashes["sha1"]);
    $('#sha256').append(d.hashes["sha256"]);
    $('#package_name').append(d.package_name);
    $('#main_activity').append(d.main_activity);
    $('#target_sdk_version').append(d.target_sdk_version);
    $('#min_sdk_version').append(d.min_sdk_version);
    $('#max_sdk_version').append(d.max_sdk_version || '-');
    $('#version_name').append(d.version_name);
    $('#version_code').append(d.version_code);
    var codes = {"normal": "info",
                 "dangerous": "danger",
                 "signature": "success",
                 "signatureOrSystem": "warning"
    };
    var level;
    for (var perm in d.detailed_permissions) {
        $('#permissions-body').append('<tr><td>'+String(perm)+'</td><td><span class="label label-'+codes[d.detailed_permissions[perm][0]]+'">'+d.detailed_permissions[perm][0]+'</span></td><td>'+d.detailed_permissions[perm][1]+'</td><td>'+d.detailed_permissions[perm][2]+'</td></tr>');
        level = codes[d.detailed_permissions[perm][0]];
    }
    
    $.each(d.activities, function(id, obj) {
        $('#activities pre').append(d.activities[id]+'\n');
    });
    $.each(d.providers, function(id, obj) {
        $('#providers pre').append(d.providers[id]+'\n');
    });
    $.each(d.receivers, function(id, obj) {
        $('#receivers pre').append(d.receivers[id]+'\n');
    });
    $.each(d.services, function(id, obj) {
        $('#services pre').append(d.services[id]+'\n');
    });
    $.each(d.libraries, function(id, obj) {
        $('#libraries pre').append(d.libraries[id]+'\n');
    });
    $('#cert-body').append(d.cert);
    $('#manifest-anal-body').append(d.manifest_analysis);
    $.each(d.strings, function(id, obj) {
        $('#strings pre').append(d.strings[id]+'\n');
    })
    $('#native').append(d.misc.Native || "false");
    $('#reflection').append(d.misc.Reflection || "false");
    $('#dynamic').append(d.misc.Dynamic || "false");
    $('#obfuscation').append(d.misc.Obfuscation || "false");

     sigma.parsers.json('data.json', {
        container: 'cfg-body',
        settings: {
          defaultNodeColor: '#ec5148'
        }
      });
}

function getData() {
    addOverlay('#report-body');
    if (status > -1) {
        //fetch the results from the DB
        $.getJSON('/api/fetch/'+app, function(data) {
            populate(data);
        })
    } else {
        $.getJSON('/api/scan/'+app+'.apk', function(data) {
            populate(data);
        })
    }
}

$( document ).ready(getData);
</script>
{% endblock %}
